# Задание 2.3 - Решение проблем с балансами счетов

## Описание задачи

Витрина `dm.account_balance_turnover` содержит данные об изменении баланса счетов по дням. Выявлена проблема: у счетов иногда отличается `account_out_sum` (сумма на конец дня) и `account_in_sum` (сумма на начало следующего дня).

## Созданные файлы решения

### 1. `task_2_3_correct_account_in_sum.sql`
**Назначение**: Запрос для определения корректного значения поля `account_in_sum`

**Логика**: 
- Если `account_in_sum` текущего дня отличается от `account_out_sum` предыдущего дня
- То корректным значением считается `account_out_sum` предыдущего дня
- Использует оконную функцию `LAG()` для получения значения предыдущего дня

**Результат**: Показывает все записи с указанием оригинальных и скорректированных значений

### 2. `task_2_3_correct_account_out_sum.sql`
**Назначение**: Запрос для определения корректного значения поля `account_out_sum`

**Логика**:
- Если `account_out_sum` текущего дня отличается от `account_in_sum` следующего дня  
- То корректным значением считается `account_in_sum` следующего дня
- Использует оконную функцию `LEAD()` для получения значения следующего дня

**Результат**: Показывает все записи с указанием оригинальных и скорректированных значений

### 3. `task_2_3_update_account_balance.sql`
**Назначение**: UPDATE запрос для исправления данных в таблице `rd.account_balance`

**Логика**:
- Использует логику из пункта 1 (корректировка `account_in_sum`)
- Обновляет только записи, где есть расхождения
- Показывает количество обновленных записей для контроля

### 4. `refresh_account_balance_turnover.sql`
**Назначение**: Процедура для полной перезагрузки витрины `dm.account_balance_turnover`

**Функциональность**:
- Очищает витрину (`DELETE FROM dm.account_balance_turnover`)
- Заново собирает данные на основе прототипа
- Применяет автоматическую коррекцию `account_in_sum` в процессе сборки
- Включает соединения с таблицами `rd.account` и `dm.dict_currency`
- Логирует количество обработанных записей

### 5. `task_2_3_example_usage.sql`
**Назначение**: Пример последовательного использования всех созданных скриптов